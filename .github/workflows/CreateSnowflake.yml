name: Run Snowflake Task Daily

on:
  schedule:
    - cron: '0 7 * * *'   # كل يوم الساعة 7 صباحًا UTC
  workflow_dispatch:

jobs:
  run-snowflake:
    runs-on: ubuntu-latest

    steps:
      # ---------------------- Checkout repo ----------------------
      - name: Checkout Repository
        uses: actions/checkout@v3

      # ---------------------- Set up Python ----------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ---------------------- Install dependencies ----------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-connector-python
          pip install pandas yagmail

      # ---------------------- Run Snowflake Script and save report ----------------------
      - name: Run Snowflake Script
        id: run_snowflake
        run: |
          python - <<EOF
import os
import snowflake.connector
import pandas as pd

# اتصال بـ Snowflake
conn = snowflake.connector.connect(
    user=os.environ['SNOW_USER'],
    password=os.environ['SNOW_PASSWORD'],
    account=os.environ['SNOW_ACCOUNT'],
    warehouse=os.environ['SNOW_WH'],
    database=os.environ['SNOW_DB'],
    schema=os.environ['SNOW_SCHEMA'],
    role=os.environ['SNOW_ROLE']
)

query = "SELECT COUNT(*) AS total_rows FROM PRODUCTION.BOOSTINY_RAW.LINK_RAW_DAILY_VALIDATED"
df = pd.read_sql(query, conn)
conn.close()

# حفظ العدد كـ output حديث
with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
    f.write(f"total_rows={df['TOTAL_ROWS'][0]}\n")
EOF
        env:
          SNOW_USER: ${{ secrets.SNOW_USER }}
          SNOW_PASSWORD: ${{ secrets.SNOW_PASSWORD }}
          SNOW_ACCOUNT: ${{ secrets.SNOW_ACCOUNT }}
          SNOW_WH: ${{ secrets.SNOW_WH }}
          SNOW_DB: ${{ secrets.SNOW_DB }}
          SNOW_SCHEMA: ${{ secrets.SNOW_SCHEMA }}
          SNOW_ROLE: ${{ secrets.SNOW_ROLE }}

      # ---------------------- Send Result Email ----------------------
      - name: Send Result Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SENDER_EMAIL }}
          password: ${{ secrets.SENDER_PASSWORD }}
          subject: "GitHub Daily Run Status: ${{ job.status }}"
          body: |
            Hello Team,

            The GitHub scheduled workflow has finished.

            Status: ${{ job.status }}
            Total rows in table LINK_RAW_DAILY_VALIDATED: ${{ steps.run_snowflake.outputs.total_rows }}

            Best Regards,
            GitHub Automation
          to: |
            Mohamed.othman@arabyads.com
            mahmoud.soror@arabyads.com
            ahmed.salah@arabyads.com
          from: "GitHub Automation <${{ secrets.SENDER_EMAIL }}>"
